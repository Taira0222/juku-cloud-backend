# アーキテクチャ設計書テンプレート

> **このファイルの使い方:**
> このテンプレートを基に `docs/architecture.md` を作成してください。
> `<!-- -->` で囲まれた部分は作成時のガイドなので、実際のドキュメントには含めないでください。

---

# アーキテクチャ設計書

<!-- このドキュメントは既存のRails APIアプリケーション (juku-cloud-backend) を基に記述します -->

## 概要

<!-- システムの目的、全体像、アーキテクチャの基本方針を記述 -->

[システムの目的を記述]

[このドキュメントのスコープを記述]

---

## 既存システムの概要

<!-- 既存のjuku-cloud-backendの情報を記載 -->

**プロジェクト:**
- リポジトリ: `juku-cloud-backend`
- フレームワーク: Ruby on Rails 8.0.2 (API mode)
- データベース: PostgreSQL
- 認証: Devise Token Auth

**既存のディレクトリ構造:**
```
app/
├── controllers/     # APIエンドポイント
├── models/          # ActiveRecordモデル
├── serializers/     # Alba (JSONシリアライザ)
├── services/        # ビジネスロジック
├── queries/         # データベースクエリ
├── jobs/            # バックグラウンドジョブ
├── mailers/         # メール送信
└── errors/          # カスタムエラー
```

**新機能の追加方針:**
<!-- 既存の構造に新機能をどう追加するか記述 -->

[既存コードとの整合性について記述]

---

## アーキテクチャパターン

**採用パターン:**
- 既存: Rails API モード + サービス層パターン
- 新規/拡張: [必要に応じて記述]

**レイヤー構成:**
- Controller → Service → Model → PostgreSQL
- Serializer: JSONレスポンス整形
- Query: 複雑なデータ取得

**選定理由:**

[なぜこのパターンを採用/継続するか]

**拡張方針:**

[今後の拡張をどう考えるか]

---

## システム構成図

<!-- 実際のシステム構成に合わせて図を更新 -->

```
┌─────────────┐
│  Frontend   │ [フロントエンドの技術を記述]
└──────┬──────┘
       │ HTTPS
┌──────▼──────────────┐
│  Rails API          │ juku-cloud-backend
│  (Puma)             │
│  ┌──────────────┐   │
│  │ Controllers  │   │
│  └──────┬───────┘   │
│  ┌──────▼───────┐   │
│  │  Services    │   │
│  └──────┬───────┘   │
│  ┌──────▼───────┐   │
│  │   Models     │   │
│  └──────┬───────┘   │
└─────────┼───────────┘
          │
┌─────────▼───────────┐
│   PostgreSQL        │
└─────────────────────┘

[その他の外部サービスがあれば追記]
```

**コンポーネント:**
- Frontend: [説明]
- Rails API: [説明]
- PostgreSQL: [説明]

**データフロー:**
[リクエストからレスポンスまでの流れを記述]

---

## レイヤー構造

<!-- 各レイヤーの役割と新機能での設計方針を簡潔に記述 -->
<!-- 実装時の具体的なコード例はguide.mdを参照 -->

### Controller (`app/controllers/api/v1/`)
**役割:** リクエスト受付、レスポンス返却、認証チェック

[新機能でのController設計方針を記述]

---

### Service (`app/services/`)
**役割:** ビジネスロジック、トランザクション管理

[新機能でのService設計方針を記述]

---

### Query (`app/queries/`)
**役割:** 複雑なデータ取得、N+1問題回避

[新機能でのQuery使用方針を記述]

---

### Model (`app/models/`)
**役割:** データ永続化、バリデーション、アソシエーション

[新機能でのModel設計方針を記述]

---

### Serializer (`app/serializers/`)
**使用ライブラリ:** Alba
**役割:** JSONレスポンス整形

[新機能でのSerializer設計方針を記述]

---

### Job (`app/jobs/`)
**役割:** 非同期処理、バックグラウンドジョブ

[新機能でのJob設計方針を記述]
[メール送信、通知、データ集計などの処理について]

---

## エラーハンドリング戦略

<!-- 統一されたエラーレスポンスとエラー処理方針を記述 -->
<!-- 実装時の具体的なコード例はguide.mdのエラーハンドリングセクションを参照 -->

### エラーレスポンス形式
**統一フォーマット:**
```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "Error message",
    "details": []
  }
}
```

[新機能で使用するエラーコードと対応するHTTPステータスコードを記述]

### エラー処理方針
**BaseControllerでの統一処理:**
[rescue_fromでの例外ハンドリング方針を記述]

**カスタムエラー:**
[app/errors/ のカスタムエラークラスの使用方針を記述]

**ログ出力:**
[エラー発生時のログ出力方針を記述]

---

## 技術スタック

### バックエンド（既存）
- Ruby 3.3 + Rails 8.0.2 (API mode)
- Puma (Webサーバー)
- PostgreSQL
- 認証: devise + devise_token_auth
- シリアライザ: alba
- テスト: rspec-rails + factory_bot

**新規追加予定のGem:**
[新機能で追加するgemがあれば記述]

---

### フロントエンド
[フロントエンドの技術スタックを記述]

---

### データベース
- PostgreSQL
- ActiveRecord ORM
- [キャッシュ戦略があれば記述]

---

### インフラ
- クラウド: AWS
- コンピューティング: [ECS/EC2など]
- CI/CD: GitHub Actions
- 監視: [使用するツールを記述]

---

## データベース設計方針

<!-- 詳細はguide.mdのデータベース設計セクションを参照 -->

### スキーマ設計
- 正規化: [第N正規形、非正規化箇所]
- インデックス: [設定するカラム、複合インデックス]
- パーティショニング: [必要に応じて記述]

### マイグレーション
- Rails標準のマイグレーション使用
- [特別な運用ルールがあれば記述]

---

## API設計方針

<!-- 既存: /api/v1/* でバージョニング。詳細はguide.md参照 -->

### RESTful設計
- リソース指向の設計
- HTTPメソッド: GET/POST/PUT/PATCH/DELETE
- ステータスコード: 2xx(成功), 4xx(クライアントエラー), 5xx(サーバーエラー)

### バージョニング
- 既存: URLバージョニング (`/api/v1/`)
- [v2への移行計画があれば記述]

### エンドポイント一覧
[新機能のエンドポイントを記述]

---

## セキュリティ

<!-- 既存: devise_token_auth使用。詳細はguide.mdのセキュリティセクション参照 -->

### 認証・認可
- 認証: devise_token_auth (トークンベース)
- [アクセス制御モデルを記述]

### データ保護
- HTTPS/TLS通信
- パスワードハッシュ化 (deviseデフォルト)
- [機密情報管理について記述]

### その他のセキュリティ対策
- CORS設定 (rack-cors)
- [レート制限があれば記述]
- [その他の対策]

---

## スケーラビリティ・可用性

<!-- 初期は最小構成でOK。必要に応じて拡張 -->

### スケーリング戦略
[水平/垂直スケーリングの方針]

### キャッシング
[キャッシュ戦略があれば記述]

### バックアップ
[バックアップ戦略を記述]

---

## 監視・ログ

### 監視
[使用する監視ツールと監視項目]

### ログ
- Railsログ
- [ログ集約ツールがあれば記述]

### アラート
[アラート設定があれば記述]

---

## デプロイメント

<!-- GitHub Actions使用。詳細は.github/workflows/参照 -->

### 環境
- 開発: [構成]
- ステージング: [構成]
- 本番: [構成]

### デプロイフロー
[実際のデプロイフローを記述]

### ロールバック
[ロールバック手順]

---

## パフォーマンス要件

<!-- システムの性能要件を記述 -->

### レスポンスタイム
- API レスポンスタイム: [目標値を記述（例: 95パーセンタイルで200ms以下）]
- データベースクエリ: [目標値を記述（例: 100ms以下）]
- バックグラウンドジョブ: [処理時間の目標を記述]

### スループット
- 同時接続数: [目標値を記述（例: 1000接続）]
- リクエスト処理数: [目標値を記述（例: 1000 req/sec）]

### リソース使用率
- CPU使用率: [上限を記述（例: 平均70%以下）]
- メモリ使用率: [上限を記述（例: 平均80%以下）]
- データベース接続プール: [設定値を記述]

### パフォーマンス最適化方針
- [N+1問題の回避方法]
- [キャッシュ戦略]
- [インデックス設計]
- [その他の最適化方針]

---

## 制約事項

### 技術的制約
[制約があれば記述]

### ビジネス制約
[制約があれば記述]

---

## 設計上の決定事項

<!-- 重要な技術選定の理由とトレードオフを記録 -->

| 決定事項 | 選択肢 | 選定理由 | トレードオフ |
|----------|--------|----------|--------------|
| [例] データベース | PostgreSQL | [理由] | [トレードオフ] |

---

## 将来の拡張性

[今後の拡張予定や考慮事項を記述]

---

## 参考資料

- [関連ドキュメント]
- [参考資料]
