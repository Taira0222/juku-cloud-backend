# CLAUDE.md - Claude Code プロジェクトガイド

## このプロジェクトについて

Juku Cloud Backendは、個人経営の学習塾向けクラウド型管理システムのバックエンドAPIです。Ruby on Rails 8.0（API mode）を採用し、RESTful APIを提供します。

本プロジェクトでは、**SDD（Specification-Driven Development / 仕様駆動開発）**を`.steering/`ワークフローで実践しています。

## ドキュメント体系

### `docs/` - プロダクト全体の永続的ドキュメント

プロダクト全体に関わる設計・方針を定義します。これらは機能横断的なドキュメントで、頻繁には更新されません。

| ファイル | 役割 | 更新タイミング |
|---------|------|---------------|
| [product-requirements.md](docs/product-requirements.md) | プロダクト要求定義書（PRD）<br>- プロダクトビジョンと目的<br>- ターゲットユーザーと課題<br>- 主要機能一覧<br>- 成功の定義 | プロダクト方針変更時 |
| [functional-design.md](docs/functional-design.md) | 機能設計書<br>- システム全体のアーキテクチャ<br>- データモデル全体図（ER図）<br>- API設計方針 | 新機能追加でアーキテクチャに影響がある場合 |
| [architecture.md](docs/architecture.md) | アーキテクチャ設計書<br>- 技術スタック<br>- インフラ構成<br>- セキュリティ戦略<br>- パフォーマンス要件 | インフラ・技術変更時 |
| [repository-structure.md](docs/repository-structure.md) | リポジトリ構造定義書<br>- ディレクトリ構成<br>- ファイル配置ルール | ディレクトリ構造変更時 |
| [development-guidelines.md](docs/development-guidelines.md) | 開発ガイドライン<br>- コーディング規約<br>- テスト戦略<br>- Git規約 | 開発プロセス変更時 |
| [glossary.md](docs/glossary.md) | ユビキタス言語定義<br>- ドメイン用語の定義<br>- 英語・日本語対応表 | 新しいドメイン概念追加時 |

### `.steering/[YYYYMMDD]-[feature]/` - 機能開発の作業ディレクトリ

個別の機能開発ごとに作成される作業ディレクトリです。**開発完了後も削除せず、履歴として永続化します。**

各ディレクトリには以下の3ファイルを含みます：

#### `requirements.md` - 要件定義
- 背景・目的（なぜこの機能が必要か）
- ユーザーストーリー
- ビジネス要件
- 制約条件

#### `design.md` - 設計書 / 仕様書（SDDの中核）
- ユースケース（詳細なフロー定義）
- データモデル（テーブル定義・リレーション）
- API仕様（リクエスト/レスポンス）
- ビジネスルール
- セキュリティ要件
- テスト戦略

**重要:** `design.md`は**仕様書**として機能します。実装前にレビューを取得し、承認後に実装を開始します。

#### `tasklist.md` - タスクリスト
- 設計フェーズのタスク
- 実装フェーズのタスク
- レビュー・マージのタスク
- 進捗管理

---

## SDD（仕様駆動開発）ワークフロー

### SDDとは

**SDD（Specification-Driven Development）**は、実装前に詳細な仕様書を作成し、それをレビュー・承認してから実装に移る開発手法です。

### SDDの利点

1. **手戻り防止:** 実装前に設計をレビューすることで、大きな手戻りを防ぐ
2. **品質向上:** 仕様書があることで、実装漏れやエッジケースの見落としを減らす
3. **コミュニケーション:** 仕様書を通じてチーム全体で設計を共有
4. **テスト設計:** 実装前にテストケースを明確化
5. **履歴管理:** `.steering/`に過去の意思決定が残る

### 新機能開発の流れ

#### 1. 作業ディレクトリ作成

```bash
mkdir -p .steering/$(date +%Y%m%d)-[feature-name]
cd .steering/$(date +%Y%m%d)-[feature-name]
```

**例:**
```bash
mkdir -p .steering/20250131-student-report
cd .steering/20250131-student-report
```

#### 2. 要件定義作成

`requirements.md`を作成し、以下を明記：
- **背景・目的:** なぜこの機能が必要か
- **ユーザーストーリー:** As a [ユーザー], I want to [アクション], so that [目的]
- **ビジネス要件:** 解決すべき課題、成功指標（KPI）
- **制約条件:** 技術的制約、スケジュール制約

**例:**
```markdown
# 生徒レポート機能 - 要件定義

## 背景・目的
講師が生徒の学習状況を月次でレポート化し、保護者に共有できるようにする。

## ユーザーストーリー
- As a 講師, I want to 生徒の月次レポートをPDFで生成できる, so that 保護者に学習状況を報告できる

## ビジネス要件
- 講師の業務効率化（手作業でのレポート作成を削減）
- KPI: レポート生成時間を50%削減

## 制約条件
- 既存のLessonNoteデータを活用
- PDFライブラリはPrawnを使用
```

#### 3. 設計書（仕様書）作成 - SDDの中核

`design.md`を作成し、以下を詳細に記述：

1. **概要:** 機能の簡潔な説明
2. **ユースケース:** 各ユースケースのフロー定義
   - アクター
   - 前提条件
   - 基本フロー
   - 代替フロー
   - 事後条件
3. **データモデル:** テーブル定義、リレーション、インデックス
4. **API仕様:** エンドポイント、リクエスト/レスポンス、エラーケース
5. **ビジネスルール:** バリデーション・計算ロジック
6. **セキュリティ要件:** 認証・認可、データ保護
7. **テスト戦略:** テストケース一覧、カバレッジ目標
8. **実装の参照:** 関連ファイルパス、既存パターンの参照

**詳細度の目安:**
「実装者が迷わず開発できる」レベルを目指してください。

**サンプル:** `.steering/idea/introduce-sdd.md`の付録Aに、Teacher Invitation機能の`design.md`サンプルがあります。

#### 4. 設計レビュー（仕様レビュー） - 最重要

**手順:**
1. `design.md`のみのPRを作成（ラベル: `spec-review`）
2. 技術メンバー1名以上（可能であれば2名）の承認を取得
3. レビュー観点：
   - 技術的実現可能性
   - API設計の一貫性（既存APIとの整合性）
   - エッジケース網羅性
   - セキュリティ・パフォーマンス要件
   - テストケースの十分性
4. 目標: 2営業日以内の承認（オフラインレビューも可）

**なぜ仕様レビューが重要か:**
- コード実装後のレビューで設計上の問題が見つかると、大幅な手戻りが発生
- 仕様レビュー段階で問題を発見すれば、ドキュメント修正のみで済む
- チーム全体で設計を共有することで、実装の一貫性を保つ

#### 5. タスクリスト作成

`tasklist.md`を作成：

```markdown
# 生徒レポート機能 - タスクリスト

## 設計フェーズ
- [x] requirements.md 作成
- [x] design.md 作成
- [x] 仕様レビューPR作成
- [x] 仕様レビュー承認取得

## 実装フェーズ
- [ ] マイグレーション作成（必要に応じて）
- [ ] モデル作成・更新
- [ ] サービス作成（Reports::GenerateService）
- [ ] クエリ作成（Reports::DataQuery）
- [ ] コントローラー作成（ReportsController）
- [ ] シリアライザ作成（Reports::ShowResource）
- [ ] テスト作成（90%以上）

## レビュー・マージ
- [ ] 実装PR作成（.steering/へのリンク含む）
- [ ] レビュー対応
- [ ] マージ

## 完了後
- [ ] docs/functional-design.md への反映（必要に応じて）
```

#### 6. 実装フェーズ

仕様レビュー承認後、実装を開始：

1. `design.md`に基づいてTDD（テスト駆動開発）で実装
2. 仕様書と実装を常に同期（仕様変更時は`design.md`も更新）
3. テストカバレッジ目標: Line 90%以上、Branch 80%以上
4. RuboCop、Brakemanをパス

**実装時の注意:**
- `design.md`に記載された内容を忠実に実装
- 仕様にない機能を勝手に追加しない
- 仕様変更が必要な場合は`design.md`を更新し、再レビュー

#### 7. 実装レビュー

実装コードのPRを作成：

1. PR説明に`.steering/[date]-[feature]/design.md`へのリンクを記載
2. レビュー観点：
   - **仕様書（design.md）との一貫性**（最重要）
   - コード品質（RuboCop）
   - テストカバレッジ（Line 90%以上）
   - セキュリティ（Brakeman）
   - パフォーマンス（Bullet）

#### 8. 完了後の処理

1. `.steering/`は削除せず残す（履歴として永続化）
2. 必要に応じて`docs/`を更新
   - 例: 新しいアーキテクチャパターンを追加した場合、`docs/functional-design.md`を更新
   - 例: 新しいドメイン用語が追加された場合、`docs/glossary.md`を更新

---

## Claude Codeを使う際のベストプラクティス

### 新機能開発を依頼する場合

**推奨依頼フォーマット:**
```
機能名: [機能名]
目的: [なぜこの機能が必要か]
ユーザーストーリー: As a [ユーザー], I want to [アクション], so that [目的]
制約条件: [あれば記載]
```

**例:**
```
機能名: 生徒の月次レポート生成機能
目的: 講師が生徒の学習状況を月次でレポート化し、保護者に共有できるようにする
ユーザーストーリー: As a 講師, I want to 生徒の月次レポートをPDFで生成できる, so that 保護者に学習状況を報告できる
制約条件: 既存のLessonNoteデータを活用、PDFライブラリはPrawnを使用
```

**簡易版（カジュアルな依頼でもOK）:**
「生徒の月次レポート機能を開発したい」

**Claudeの動作:**
1. `.steering/[date]-student-report/`ディレクトリ作成
2. `requirements.md`作成（背景・ユーザーストーリー確認）
3. `design.md`作成（仕様書として詳細設計）
4. `tasklist.md`作成
5. 仕様レビューPR作成の提案
6. 承認後、実装開始

### 既存機能の仕様書化（レトロスペクティブ仕様書）

**ユーザーの依頼例:**
「Teacher Invitation機能の仕様書を作成して」

**Claudeの動作:**
1. 既存コード・テストを分析
2. `.steering/[date]-teacher-invitation-retro-spec/`作成
3. `design.md`に仕様を逆算して記述
4. 既存実装との差分があれば指摘

### 仕様レビュー時のポイント

Claudeに仕様レビューを依頼する場合：
「.steering/20250131-student-report/design.md をレビューして」

**レビュー観点:**
- 技術的実現可能性
- 既存アーキテクチャとの一貫性
- セキュリティリスク
- パフォーマンスボトルネック
- エッジケースの網羅性
- テストケースの十分性

---

## よくある質問

### Q1: `docs/functional-design.md` と `.steering/*/design.md` の違いは？

**A:**
- `docs/functional-design.md` = システム**全体**の機能設計・アーキテクチャ
  - 例: レイヤー構造、データモデル全体図、API設計方針
- `.steering/*/design.md` = **個別機能**の詳細設計（仕様書）
  - 例: Teacher Invitation機能のユースケース、API仕様、テストケース

### Q2: 開発完了後、`.steering/`は削除する？

**A:** いいえ、削除しません。`.steering/`は**履歴として永続化**し、過去の意思決定を追跡できるようにします。

**理由:**
- 「なぜこの設計にしたのか」を後から確認できる
- 同様の機能を開発する際の参考になる
- 新メンバーがプロジェクトの歴史を理解できる

### Q3: `design.md`に書くべきレベルは？

**A:** 「実装者が迷わず開発できる」レベルを目指してください。

**具体的には:**
- ユースケース（フローチャート相当の詳細度）
- API仕様（リクエスト/レスポンスの例を含む）
- データモデル（テーブル定義、インデックス、リレーション）
- ビジネスルール（バリデーション・計算ロジックの明確化）
- テストケース（正常系・異常系・境界値）

**良い例（適切なレベル）:**
```markdown
## API仕様

### POST /api/v1/reports
生徒の月次レポートを生成する

#### リクエスト
```json
{
  "student_id": 123,
  "year_month": "2025-01"
}
```

#### レスポンス (200 OK)
```json
{
  "report_url": "https://example.com/reports/123.pdf",
  "generated_at": "2025-01-31T10:00:00Z"
}
```

#### ビジネスルール
- BR-001: レポート生成は当月および過去3ヶ月分のみ可能
- BR-002: 同一月のレポートは1日1回まで生成可能
```
→ **何を実装するか**が明確で、実装者が迷わない

**悪い例（書きすぎ）:**
```markdown
## 実装詳細

### Reports::GenerateServiceの実装
```ruby
class Reports::GenerateService
  def self.call(student_id:, year_month:)
    student = Student.find(student_id)
    lessons = student.lesson_notes.where(
      created_at: Date.parse(year_month).beginning_of_month..Date.parse(year_month).end_of_month
    )
    # ... 詳細なコード例
  end
end
```
```
→ 実装の詳細まで書きすぎ。「どうやって実装するか」は実装者に任せるべき

**書きすぎ注意:**
- 実装の細かいコード例は不要（「どうやって実装するか」は実装者に任せる）
- 「何を実装するか」を明確にするのが仕様書の役割

### Q4: 仕様変更が発生した場合は？

**A:**
1. `design.md`を更新
2. 変更内容を`design.md`の「変更履歴」セクションに記載
3. 必要に応じて再レビュー
4. 実装を修正

**重要:** 仕様書と実装を常に同期させてください。

### Q5: 小さな機能でもSDDが必要？

**A:** 規模に応じて柔軟に対応してください。

**SDDが推奨される場合:**
- 新規テーブル作成を伴う機能
- 複数のモデル・テーブルを変更する機能
- APIエンドポイントを追加する機能
- セキュリティに関わる機能
- 複雑なビジネスロジックを含む機能

**具体例:**
- ✅ 新規テーブル作成（例: Reportsテーブル追加） → SDD推奨
- ✅ 既存テーブルへのカラム複数追加（例: 3カラム以上） → SDD推奨
- ❌ 既存テーブルへのカラム1つ追加（例: `students.phone`追加） → SDDスキップ可
- ❌ 既存APIのレスポンス項目追加のみ → SDDスキップ可

**SDDが不要な場合:**
- 軽微なバグ修正
- 既存機能の小さな調整（UI文言変更、バリデーションメッセージ変更など）
- ドキュメント修正
- リファクタリング（機能変更を伴わない）

### Q6: 古い`.steering/`ディレクトリはいつアーカイブ/削除する？

**A:** 基本的に削除しません。ただし、プロジェクトが大規模化した場合は以下のルールでアーカイブを検討してください。

**アーカイブ対象:**
- 実装されなかった機能（PoC・試作のみで本番未導入）
- 削除された機能（廃止済み機能の仕様書）

**アーカイブ方法:**
1. `.steering/archive/[YYYY]/`ディレクトリに移動
2. README.mdにアーカイブ理由を記載

**例:**
```
.steering/
├── 20250115-teacher-invitation/    # 実装済み・稼働中
├── 20250120-lesson-notes-crud/     # 実装済み・稼働中
└── archive/
    └── 2024/
        └── 20241201-experimental-ai-tutor/  # PoC・未実装
```

**削除してはいけないケース:**
- 実装済みで稼働中の機能
- 将来の参考になる可能性のある設計

---

## 参照すべきファイル（優先順）

### 初回開発者向け（プロジェクト参加時）

初めてこのプロジェクトで作業する場合は、以下の順序でドキュメントを読んでください：

1. **CLAUDE.md**（このファイル）- プロジェクトガイド・SDD方法論
2. **docs/product-requirements.md** - プロダクトビジョン・目的の理解
3. **docs/glossary.md** - ドメイン用語の正確な定義
4. **docs/architecture.md** - 技術スタック・インフラ構成
5. **docs/functional-design.md** - システム全体の設計方針
6. **docs/development-guidelines.md** - コーディング規約・テスト戦略
7. **docs/repository-structure.md** - ディレクトリ構成
8. **.steering/[既存のfeature]/design.md** - 既存機能の実装パターン参照

### 機能開発時

個別の機能開発を行う場合は、以下の順序で参照してください：

1. **CLAUDE.md**（このファイル）- SDD方法論の確認
2. **docs/development-guidelines.md** - コーディング規約・テスト戦略
3. **docs/glossary.md** - ドメイン用語の正確な定義
4. **docs/functional-design.md** - システム全体の設計方針（既存APIとの整合性確認）
5. **docs/architecture.md** - 技術的制約・パフォーマンス要件
6. **.steering/[類似のfeature]/design.md** - 関連機能の実装パターン参照

---

## プロジェクトの技術スタック（概要）

### 現在使用中の技術

- **Ruby:** 3.4.4
- **Rails:** 8.0.3 (API mode)
- **データベース:** PostgreSQL 15
- **認証:** devise_token_auth
- **シリアライザ:** Alba
- **ページネーション:** Kaminari
- **テスト:** RSpec, FactoryBot, SimpleCov
- **静的解析:** RuboCop, Brakeman, Bullet
- **インフラ:** AWS (ECS Fargate, RDS, ALB)
- **CI/CD:** GitHub Actions

### 将来導入予定の技術

- **Redis:** キャッシュストア（科目一覧、School情報等の頻繁に変更されないデータ）
- **バックグラウンドジョブ:** Sidekiq（Redisベース）

詳細は[architecture.md](docs/architecture.md)を参照してください。

---

## 開発ガイドライン（要約）

### レイヤー構造

```
┌─────────────────────────────────────────┐
│ Controller (app/controllers/)          │
│ - リクエスト受付・レスポンス返却       │
│ - 認証・認可チェック                   │
└───────────┬─────────────────────────────┘
            │
            ├──→ Query (app/queries/)
            │    - 複雑なデータ取得
            │    - N+1問題回避
            │
            ├──→ Service (app/services/)
            │    - ビジネスロジック
            │    - トランザクション管理
            │
            ↓
┌─────────────────────────────────────────┐
│ Model (app/models/)                     │
│ - データ永続化                          │
│ - バリデーション                        │
└───────────┬─────────────────────────────┘
            │
            ↓
┌─────────────────────────────────────────┐
│ PostgreSQL                              │
└─────────────────────────────────────────┘
            ↑
            │
┌─────────────────────────────────────────┐
│ Serializer (app/serializers/)           │
│ - JSONレスポンス整形 (Alba)             │
└─────────────────────────────────────────┘
```

**レイヤーの役割:**
- **Controller:** リクエスト処理のみ（薄いController）
- **Query:** 複雑なデータ取得・検索ロジックの分離
- **Service:** ビジネスロジック・複数モデルの操作
- **Model:** データ構造定義・バリデーション（Thin Model）
- **Serializer:** APIレスポンスの整形

詳細なコーディング規約・テスト戦略・Git規約は[development-guidelines.md](docs/development-guidelines.md)を参照してください。

---

## SDD導入のメリット（再確認）

1. **手戻り防止:** 実装前の設計レビューで大きな手戻りを防ぐ
2. **品質向上:** 仕様書があることで、実装漏れやエッジケースの見落としを減らす
3. **コミュニケーション:** 仕様書を通じてチーム全体で設計を共有
4. **テスト設計:** 実装前にテストケースを明確化
5. **履歴管理:** `.steering/`に過去の意思決定が残る
6. **AI駆動開発:** Claude Codeが仕様書を理解し、高品質な実装を支援

---

以上がこのプロジェクトのドキュメント体系とSDD（仕様駆動開発）ワークフローです。

新しい開発タスクを始める際は、必ずこのガイドに従ってください。
