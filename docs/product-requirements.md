# プロダクト要求定義書

## 概要

**プロダクト名:** Juku Cloud

**目的:** 個人経営の学習塾向けに、生徒管理・授業記録・成績追跡を一元化したクラウド型管理システムを提供し、講師の業務効率化と生徒の学習成果向上を実現する。

## 背景と課題

### 現状の課題

- 講師は紙やExcelで生徒情報・授業記録・成績を管理しており、データの紛失リスクや検索性の低さが問題
- 複数の生徒の授業内容や進捗状況を把握するのに時間がかかり、個別最適化された指導が困難
- 保護者への報告資料作成に時間がかかり、本来の指導準備時間が削られている
- 生徒・保護者とのコミュニケーションがメール・LINE・電話に散在し、履歴管理が困難
- 塾の成長に伴う生徒数増加に対して、既存の管理手法ではスケールしない

### 解決したい問題

- 生徒の基本情報・授業記録・成績データを一元管理し、講師がいつでもどこからでもアクセス・更新できるようにする
- 授業ごとの指導内容・宿題・次回予定を記録し、継続的な指導計画を立てやすくする
- 生徒の成績推移をグラフ化し、視覚的に理解度・苦手分野を把握できるようにする
- セキュアな招待システムにより、複数講師での共同運営を可能にする

### ターゲットユーザー

- **プライマリ:** 個人経営の学習塾講師（20-60代、ITリテラシー中程度、1塾あたり生徒5-50名）
- **セカンダリ:** 複数講師で運営する小規模塾（2-5名の講師、生徒20-100名）
- **想定ユーザー数:**
  - 初年度: 50塾、500生徒
  - 1年後: 500塾、5,000生徒
  - 3年後: 5,000塾、50,000生徒

## ユーザーストーリー

### ユーザー認証・招待

**As a** School管理者（admin role）
**I want to** 新しい講師を安全に招待したい
**So that** 複数講師で塾を共同運営できる

**受け入れ条件:**
- [ ] 招待トークンが暗号学的に安全な方法で生成される（HMAC-SHA256）
- [ ] トークンの有効期限が7日間に設定される
- [ ] 招待トークンは1回のみ使用可能
- [ ] 無効なトークンでの登録が拒否される
- [ ] トークン生成はadmin roleのみが実行可能

**優先度:** Must Have (MVP必須)

---

**As a** 招待された講師
**I want to** 招待トークンを使ってアカウント登録したい
**So that** 安全に塾のシステムにアクセスできる

**受け入れ条件:**
- [ ] 招待URLから登録画面にアクセスできる
- [ ] メールアドレスとパスワードで登録できる
- [ ] パスワードは8文字以上、英数字を含む必要がある
- [ ] 登録完了後、自動的にSchoolに所属する
- [ ] 既に存在するメールアドレスでは登録できない

**優先度:** Must Have (MVP必須)

---

**As a** 登録済み講師
**I want to** メールアドレスとパスワードでログインしたい
**So that** 安全にシステムにアクセスできる

**受け入れ条件:**
- [ ] メールアドレスとパスワードで認証できる
- [ ] 認証成功時にaccess-token/client/uidヘッダーが返却される
- [ ] トークンは24時間有効
- [ ] ログイン失敗時に適切なエラーメッセージが表示される
- [ ] 30分無操作でセッションがタイムアウトする

**優先度:** Must Have (MVP必須)

---

### 生徒管理

**As a** 講師
**I want to** 新しい生徒を登録したい
**So that** 生徒情報を一元管理できる

**受け入れ条件:**
- [ ] 生徒の基本情報（名前、学年、連絡先）を登録できる
- [ ] 生徒一覧を学年・名前でフィルタリングできる
- [ ] 生徒情報を編集・削除できる
- [ ] 削除時に関連する授業記録も削除される（cascade delete）
- [ ] ページネーション機能がある（1ページ20件）

**優先度:** Must Have (MVP必須)

---

### 授業記録管理

**As a** 講師
**I want to** 授業完了後に授業内容を記録したい
**So that** 指導履歴を追跡し、次回の授業計画を立てやすくできる

**受け入れ条件:**
- [ ] 授業日時、科目、指導内容を記録できる
- [ ] 理解度（1-5段階）を記録できる
- [ ] 宿題内容を記録できる
- [ ] 次回の指導予定を記録できる
- [ ] 生徒ごとの授業履歴を時系列で表示できる
- [ ] 科目でフィルタリングできる

**優先度:** Must Have (MVP必須)

---

**As a** 講師
**I want to** 過去の授業記録を検索・参照したい
**So that** 指導の継続性を保ち、効果的な指導計画を立てられる

**受け入れ条件:**
- [ ] 生徒・科目・期間で授業記録を検索できる
- [ ] 授業記録一覧をソート（日付順・科目順）できる
- [ ] 授業記録の詳細を表示できる
- [ ] 授業記録を編集・削除できる
- [ ] 検索結果がページネーションされる

**優先度:** Must Have (MVP必須)

---

### 科目管理

**As a** 講師
**I want to** 指導科目を管理したい
**So that** 授業記録時に科目を選択できる

**受け入れ条件:**
- [ ] 科目を作成・編集・削除できる
- [ ] 科目一覧を表示できる
- [ ] 科目名の重複を防ぐバリデーションがある
- [ ] 削除時に授業記録が存在する場合は警告が表示される

**優先度:** Should Have

---

### 成績分析（将来機能）

**As a** 講師
**I want to** 生徒の理解度推移をグラフで確認したい
**So that** 苦手分野を特定し、効果的な指導ができる

**受け入れ条件:**
- [ ] 科目ごとの理解度推移を折れ線グラフで表示できる
- [ ] 期間（1ヶ月、3ヶ月、6ヶ月）でフィルタリングできる
- [ ] 複数科目を比較表示できる
- [ ] グラフからPDFレポートを生成できる

**優先度:** Nice to Have (将来機能)

---

## 機能要件

### 必須機能（Must Have - MVPに含める）

1. **ユーザー認証**
   - 講師招待機能（HMAC-SHA256トークンベース）
   - メールアドレス・パスワードによる新規登録
   - ログイン・ログアウト（devise_token_auth）
   - Role-Based Access Control（admin / teacher）

2. **生徒管理**
   - 生徒の作成・編集・削除
   - 生徒一覧表示（ページネーション、フィルタリング）
   - 生徒詳細表示

3. **授業記録管理（Lesson Notes）**
   - 授業記録の作成・編集・削除
   - 授業記録一覧表示（生徒・科目・期間でフィルタリング）
   - 授業記録詳細表示（指導内容、理解度、宿題、次回予定）

4. **科目管理**
   - 科目の作成・編集・削除
   - 科目一覧表示

### 推奨機能（Should Have - MVP後すぐに追加）

1. **通知機能**
   - 授業記録作成時の生徒への通知（メール）
   - リマインダー機能（次回授業の前日通知）

2. **レポート機能**
   - 月次レポートの自動生成（生徒の授業回数・理解度推移）
   - PDFエクスポート

3. **検索機能の強化**
   - 全文検索（授業内容・宿題内容）
   - タグ機能（授業記録へのタグ付け）

### 将来機能（Nice to Have - 需要次第で検討）

1. **成績分析ダッシュボード**
   - 理解度推移グラフ
   - 科目別成績比較
   - 苦手分野の自動検出

2. **保護者向け機能**
   - 保護者アカウントの作成
   - 生徒の授業履歴閲覧（保護者ビュー）
   - 講師とのメッセージ機能

3. **複数校舎対応**
   - School階層の導入
   - 校舎間での生徒・講師の移動管理

4. **決済機能**
   - レッスン料金の決済
   - 請求書発行

## 非機能要件

### パフォーマンス

- **APIレスポンスタイム:** 95パーセンタイルで200ms以下
- **ページ読み込み時間:** 初回3秒以内、2回目以降1秒以内（モバイル4G回線）
- **同時接続数:** 初期500接続、1年後5,000接続に対応
- **データベースクエリ:** N+1問題を排除し、複雑なクエリは100ms以内
- **カバレッジ目標:** Line 95%以上、Branch 85%以上（現在: Line 98%, Branch 89% - この水準を維持）

### セキュリティ

- **通信:** HTTPS/TLS 1.3通信の強制
- **認証:** devise_token_authによるトークンベース認証（access-token/client/uid）
- **トークン有効期限:** 24時間
- **パスワード:** bcryptでハッシュ化（cost=12）
- **セッション:** 30分無操作でタイムアウト
- **OWASP対策:**
  - SQLインジェクション対策（ActiveRecordのパラメータ化クエリ）
  - XSS対策（CSP設定、フロントエンドでのサニタイゼーション）
  - CSRF対策（トークン検証）
- **招待トークン:** HMAC-SHA256でハッシュ化（生トークンはDBに保存しない）
- **定期的なセキュリティスキャン:** Brakeman、Bundler Audit

### スケーラビリティ

- **初期想定:** 50塾、500生徒
- **1年後目標:** 500塾、5,000生徒
- **3年後目標:** 5,000塾、50,000生徒
- **水平スケーリング:** ECS FargateのTask数増加で対応可能な設計
- **データベース:** PostgreSQL読み取りレプリカの追加でスケール
- **将来的なMulti-AZ対応:** RDSのSingle-AZからMulti-AZへの移行可能性を確保

### 可用性

- **目標稼働率:** 99.9%（月間ダウンタイム43分以内）
- **バックアップ:** 日次自動バックアップ（RDS自動バックアップ）、7日間保持
- **リカバリー:** RPO（目標復旧時点）24時間、RTO（目標復旧時間）4時間
- **監視:** CloudWatch Logsでエラー率、レスポンスタイム、CPU/メモリ使用率を24/7監視
- **障害対応:** 重大障害は1時間以内に対応開始

### 互換性

- **バックエンド:** Ruby 3.4.4 / Rails 8.0.3（API mode）
- **データベース:** PostgreSQL 15
- **フロントエンド:** モバイルブラウザ（iOS Safari、Android Chrome）対応
- **API:** RESTful API（JSON形式）

## 成功指標（KPI）

### ビジネスKPI

1. **MAU（月間アクティブユーザー数）:**
   - 3ヶ月後: 50塾、50人
   - 6ヶ月後: 100塾、100人
   - 1年後: 500塾、500人

2. **アクティブ塾の定義:** 月に1回以上授業記録を作成したSchool

3. **生徒登録数:**
   - 3ヶ月後: 500人
   - 6ヶ月後: 1,000人
   - 1年後: 5,000人

4. **1塾あたりの平均生徒数:**
   - 目標: 10人以上

### 利用状況KPI

5. **授業記録作成数:**
   - 3ヶ月後: 月間1,000件
   - 6ヶ月後: 月間5,000件
   - 1年後: 月間15,000件

6. **1講師あたりの平均授業記録数:**
   - 目標: 月間20件以上（週5件 × 4週）

7. **平均セッション時間:**
   - 目標: 講師8分以上、生徒3分以上（将来的な保護者ビュー実装時）

8. **データ入力完了率:**
   - 目標: 90%以上（授業記録作成時に理解度・宿題・次回予定が全て入力される割合）

### 技術KPI

9. **システム稼働率:**
   - 目標: 99.9%以上

10. **APIレスポンスタイム:**
    - 目標: 95パーセンタイルで200ms以下

11. **エラー率:**
    - 目標: 0.1%以下（全リクエストに対するエラーの割合）

12. **テストカバレッジ:**
    - Line: 95%以上（現在98% - この水準を維持）
    - Branch: 85%以上（現在89% - この水準を維持）

## 制約事項

### 技術的制約

- **既存技術スタック:** Ruby on Rails 8.0（API mode）、PostgreSQL 15を使用する
- **認証方式:** devise_token_authを採用（access-token/client/uidヘッダーによるステートレス認証）
- **インフラ:** AWS ECS Fargate + RDS（Single-AZ、将来的にMulti-AZ移行可能）
- **シリアライザ:** Albaを使用してレスポンスを統一
- **ページネーション:** Kaminariを使用
- **互換性:** フロントエンドとのREST API通信（JSON形式）
- **デプロイ:** GitHub Actions経由でECR/ECSへ自動デプロイ

### ビジネス制約

- **予算:** 初期開発費用200万円、運用費用月額10万円（AWS料金含む）
- **法規制:** 個人情報保護法への対応が必須（生徒の個人情報を扱うため）
- **競合:** 既存の学習管理システム（Studyplus、Classi等）と差別化する必要がある
- **ターゲット:** 個人経営〜小規模塾に特化（大規模塾向け機能は後回し）


## リスクと対策

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| **AWS障害によるサービス停止** | 高 | 低 | Multi-AZ構成への移行準備、CloudWatch監視とアラート設定、障害発生時の通信手段確保 |
| **ユーザー数急増によるサーバー負荷** | 高 | 低 | ECS Auto Scalingの設定、事前の負荷テスト実施、スケーリングアラート設定 |
| **データベースのパフォーマンス劣化** | 中 | 中 | インデックスの適切な設定、N+1問題の排除（Bulletで検出）、QueryオブジェクトでのSQL最適化、読み取りレプリカの追加検討 |
| **セキュリティ脆弱性の発見** | 高 | 中 | Brakeman/Bundler Auditによる定期スキャン、依存ライブラリの定期更新、GitHub Dependabotの活用 |
| **スケジュール遅延** | 中 | 中 | 2週間ごとのスプリントレビュー、MVP機能の優先順位付け、Should Have機能を延期可能な設計 |
| **競合サービスの台頭** | 中 | 低 | 個人塾特化のUX強化、早期リリースでユーザー獲得、ユーザーフィードバックの迅速な反映 |
| **データ損失** | 高 | 低 | RDS自動バックアップ（7日間保持）、定期的なリカバリーテスト実施 |
| **CORS設定ミスによるAPI接続不可** | 中 | 低 | 環境ごとのCORS設定管理、デプロイ前の接続テスト必須 |

## 用語集

| 用語 | 定義 |
|------|------|
| **MVP** | Minimum Viable Product（実用最小限の製品）。最小限の機能でリリースし、ユーザーフィードバックを得る手法 |
| **MAU** | Monthly Active Users（月間アクティブユーザー数）。月に1回以上サービスを利用したユーザーの数 |
| **devise_token_auth** | Rails用のトークンベース認証gemライブラリ。access-token/client/uidヘッダーでステートレス認証を実現 |
| **bcrypt** | パスワードをハッシュ化するためのアルゴリズム |
| **HMAC-SHA256** | ハッシュベースのメッセージ認証コード。招待トークンの改ざん防止とDB検索性を両立するために採用 |
| **N+1問題** | データベースクエリの非効率な実行パターン。親レコード取得後に各子レコードを個別に取得することで発生 |
| **RPO** | Recovery Point Objective（目標復旧時点）。障害発生時に失われても許容できるデータの時間範囲 |
| **RTO** | Recovery Time Objective（目標復旧時間）。障害発生から復旧までの許容時間 |
| **OWASP Top 10** | Webアプリケーションの代表的なセキュリティリスクトップ10 |
| **ECS Fargate** | AWSのコンテナオーケストレーションサービス。サーバーレスでコンテナを実行 |
| **RDS** | Amazon Relational Database Service。マネージドなリレーショナルデータベースサービス |
| **Alba** | Railsのシリアライザgemライブラリ。JSONレスポンスの統一化に使用 |
| **Kaminari** | Railsのページネーションgemライブラリ |
| **Bullet** | N+1クエリ検出gemライブラリ。開発時に非効率なクエリを警告 |
| **Brakeman** | Railsアプリケーションのセキュリティ脆弱性を静的解析するツール |
| **School** | 塾の組織単位。複数の講師（User）が所属する |
| **User** | 講師アカウント。admin roleまたはteacher roleを持つ |
| **Student** | 生徒。Schoolに所属し、授業記録（Lesson Note）の対象となる |
| **Lesson Note** | 授業記録。講師が授業完了後に記録する指導内容・理解度・宿題・次回予定 |
| **Subject** | 科目。授業記録の分類に使用（数学、英語、国語など） |
| **Invite** | 招待トークン。管理者が新しい講師を招待するためのセキュアなトークン |
| **Role** | ユーザーの権限レベル。admin（管理者）またはteacher（講師） |
